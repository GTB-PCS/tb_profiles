# Tuberculosis country profiles
Show a selecton of important indicators concerning tuberculosis (TB) in a chosen country or area. Such a selection is known as a *country profile*.

## Features

* Choose from 216 countries and areas
* Choose interface and results in English, French, Russian or Spanish
* View results as tables and charts displayed under a series of thematic tabs

## Components and data source

This is an app built using [Shiny](https://shiny.rstudio.com/). It uses data published by the World Health Organization's [Global Tuberculosis Programme](https://www.who.int/tb/data).

The app pulls data directly from the global TB database. Unfortunately there is no standard api with which to interogate the database, so I built a script and some queries to return JSON files specifically for this app.

The script can return three types of JSON file:

1. https://extranet.who.int/tme/generateJSON.asp?ds=countries. This returns a list of all countries and areas which report TB data annually to WHO. The list includes the entity name in English, French, Spanish and Russian.

2. https://extranet.who.int/tme/generateJSON.asp?ds=labels&lan=XX  (where XX is a two-letter language code, EN=English, ES=Spanish, FR=French, RU=Russian). This returns all the text that appear in the user interface such as headings, paragraphs, tables, legends, etc., in the chosen language.

3. https://extranet.who.int/tme/generateJSON.asp?ds=data&iso2=XX (where XX is a country [ISO2 code](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2)). This returns all the data that appear in the tables and charts for the chosen country or area.


## Data updates

WHO collects TB data annually from all countries and areas and publishes them in the  [Global Tuberculosis Report](https://www.who.int/tb/publications/global_report/en/), usually in October of each year.


***

## Graphics

The app uses standard [ggplot2](https://ggplot2.tidyverse.org/) charts. I experimented with converting the charts to [plotly](https://plot.ly/r/) for a bit of interactivity,  but decided against it because:

1. The URLs get really long and messed up; I like the simple URLs which simply show the language, country ISO2 code and tab to display.

2. The style of headings is slightly different and needs tweaking, plus ggplot2 subheadings do not get automatically converted meaning I'd need to fudge it a bit as shown in [this post](https://datascott.com/blog/subtitles-with-ggplotly/).

3. The dark gray horizontal gridlines render as dark gray when printing so have to faff about with themes to overcome this.

None of these are deal breakers, but they made enough of a difference to convince me that the marginal gain was not worth the extra effort. 

To convert a chart to using plotly:

```

# In app.R:
# - - - - - 
# include the plotly package

library(plotly)

# In ui():
# - - - - 
# Change plotOutput() to plotlyOutput(), for example:

plotlyOutput(outputId = "mort_chart")

# In server():
# - - - - - -
# Change renderPlot() to renderPlotly(), and within it return the result
# of applying ggplotly() to the plot object generated by ggplot(), for example:

output$mort_chart <-  renderPlotly({

  # Make sure there are data to plot
  req(pdata()$epi_timeseries)

  plot <- pdata()$epi_timeseries %>%
          ggplot(aes(x=year, y=e_mort_exc_tbhiv_100k, ymin=0)) +
          geom_line(size=1,
      		          colour=standard_palette("mortality_exc_tbhiv")) +

          geom_ribbon(aes(x=year, ymin=e_mort_exc_tbhiv_100k_lo, ymax=e_mort_exc_tbhiv_100k_hi),
                      fill=standard_palette("mortality_exc_tbhiv"),
                      alpha=0.4) +

           scale_x_continuous(name="", breaks = c(2000, 2005, 2010, 2015, dcyear-1)) +

           profile_theme() +

           ggtitle(ltxt(plabs(), "mortality_hivneg"),
                   subtitle = ltxt(plabs(), "rate_100k_yr") )

    # convert to plotly
    return(ggplotly(plot))

})

```
